<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Courtyard ‚Äî Resident Directory</title>

<!--
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  CHANGE THE PASSWORD HERE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  Find the line below and update it:
  password: 'cmcds'
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-->

<style>
  :root {
    --cream: #f5f0e8;
    --warm: #faf7f2;
    --stone: #b8ad9e;
    --dark: #1e1a16;
    --mid: #6b5f52;
    --accent: #7a5c3e;
    --accent2: #c4956a;
    --green: #3d6b4a;
    --red: #8b3a3a;
    --border: #ddd5c8;
    --shadow: 0 4px 24px rgba(30,26,22,0.10);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: Arial, sans-serif; font-size: 12px; background: var(--cream); color: var(--dark); min-height: 100vh; }

  /* PASSWORD SCREEN */
  #passwordScreen {
    min-height: 100vh; display: flex; align-items: center; justify-content: center;
    background: var(--dark); position: relative; overflow: hidden;
  }
  #passwordScreen::before {
    content: ''; position: absolute; inset: 0;
    background: radial-gradient(ellipse at 30% 60%, rgba(122,92,62,0.25) 0%, transparent 60%),
                radial-gradient(ellipse at 75% 20%, rgba(196,149,106,0.12) 0%, transparent 50%);
  }
  .login-card {
    position: relative; background: rgba(250,247,242,0.06);
    border: 1px solid rgba(196,149,106,0.25); border-radius: 12px;
    padding: 3rem 3.5rem; width: 100%; max-width: 400px;
    backdrop-filter: blur(10px); text-align: center;
  }
  .login-emblem {
    width: 56px; height: 56px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    margin: 0 auto 1.5rem; font-size: 1.4rem;
  }
  .login-card h2 {
    font-family: Arial, sans-serif; font-size: 1.9rem; font-weight: 500;
    color: var(--cream); margin-bottom: 0.4rem; letter-spacing: 0.02em;
  }
  .login-card p { color: var(--stone); font-size: 0.83rem; margin-bottom: 2rem; font-weight: 300; }
  .pw-field { position: relative; margin-bottom: 0.5rem; }
  .pw-field input {
    width: 100%; padding: 0.85rem 1rem;
    background: rgba(255,255,255,0.07); border: 1px solid rgba(196,149,106,0.3);
    border-radius: 6px; color: var(--cream); font-family: Arial, sans-serif;
    font-size: 0.95rem; letter-spacing: 0.1em; text-align: center; transition: all 0.2s;
  }
  .pw-field input::placeholder { letter-spacing: 0.05em; color: rgba(184,173,158,0.5); }
  .pw-field input:focus { outline: none; border-color: var(--accent2); background: rgba(255,255,255,0.1); box-shadow: 0 0 0 3px rgba(196,149,106,0.15); }
  .pw-field input.shake { animation: shake 0.4s ease; border-color: var(--red) !important; }
  @keyframes shake { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-8px)} 40%{transform:translateX(8px)} 60%{transform:translateX(-5px)} 80%{transform:translateX(5px)} }
  .pw-error { color: #e07070; font-size: 0.78rem; margin-bottom: 0.75rem; min-height: 1.2rem; }
  .login-btn {
    width: 100%; padding: 0.9rem;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: white; border: none; border-radius: 6px; font-family: Arial, sans-serif;
    font-size: 0.9rem; font-weight: 500; letter-spacing: 0.06em; text-transform: uppercase;
    cursor: pointer; transition: all 0.2s;
  }
  .login-btn:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 4px 16px rgba(122,92,62,0.4); }

  /* MAIN APP */
  #app { display: none; }
  header {
    background: var(--dark); padding: 1.5rem 2.5rem;
    display: flex; align-items: center; justify-content: space-between;
    flex-wrap: wrap; gap: 1rem; border-bottom: 1px solid rgba(196,149,106,0.2);
  }
  .header-brand h1 { font-family: Arial, sans-serif; color: var(--cream); font-size: 1.6rem; font-weight: 500; letter-spacing: 0.03em; }
  .header-brand p { color: var(--stone); font-size: 0.78rem; margin-top: 0.1rem; font-weight: 300; letter-spacing: 0.04em; text-transform: uppercase; }
  .header-actions { display: flex; gap: 0.6rem; align-items: center; }
  .save-status {
    font-size: 0.78rem; color: var(--green); display: flex; align-items: center; gap: 0.35rem;
    padding: 0.3rem 0.75rem; background: rgba(61,107,74,0.15); border-radius: 20px;
    border: 1px solid rgba(61,107,74,0.3); transition: all 0.3s;
  }
  .save-status.unsaved { color: var(--accent2); background: rgba(196,149,106,0.12); border-color: rgba(196,149,106,0.3); }
  .btn {
    padding: 0.5rem 1.1rem; border-radius: 5px; border: none; cursor: pointer;
    font-family: Arial, sans-serif; font-size: 0.82rem; font-weight: 500;
    letter-spacing: 0.03em; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem;
  }
  .btn-outline { background: transparent; color: var(--stone); border: 1px solid #3a3530; }
  .btn-outline:hover { background: #2a2520; color: var(--cream); }
  .btn-accent { background: var(--accent); color: white; }
  .btn-accent:hover { background: #6a4c30; }
  .btn-save { background: var(--green); color: white; }
  .btn-save:hover { background: #2d5437; }
  .btn-lock { background: transparent; color: var(--stone); border: 1px solid #3a3530; font-size: 0.75rem; }
  .btn-lock:hover { background: #2a2520; color: #e07070; }
  main { max-width: 1050px; margin: 2rem auto; padding: 0 1.5rem 4rem; }
  .stats-row { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
  .stat-card {
    background: white; border: 1px solid var(--border); border-radius: 8px;
    padding: 0.9rem 1.4rem; display: flex; align-items: center; gap: 1rem;
    box-shadow: var(--shadow); flex: 1; min-width: 130px;
  }
  .stat-num { font-family: Arial, sans-serif; font-size: 2rem; color: var(--accent); line-height: 1; font-weight: 600; }
  .stat-label { font-size: 0.72rem; color: var(--mid); text-transform: uppercase; letter-spacing: 0.07em; line-height: 1.4; }
  .setup-banner {
    background: linear-gradient(135deg, #fdf3e7, #fef8f1);
    border: 1px solid #e8c99a; border-radius: 8px;
    padding: 1.25rem 1.5rem; margin-bottom: 1.5rem;
    display: flex; align-items: flex-start; gap: 1rem;
  }
  .setup-banner .icon { font-size: 1.4rem; flex-shrink: 0; margin-top: 0.1rem; }
  .setup-banner h3 { font-size: 0.9rem; font-weight: 500; color: var(--accent); margin-bottom: 0.3rem; }
  .setup-banner p { font-size: 0.8rem; color: var(--mid); line-height: 1.5; }
  .setup-banner code { background: rgba(122,92,62,0.1); padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.75rem; color: var(--accent); font-family: monospace; }
  .setup-fields { display: flex; gap: 0.5rem; margin-top: 0.75rem; flex-wrap: wrap; }
  .setup-input { flex: 1; min-width: 200px; padding: 0.5rem 0.75rem; border: 1px solid #e8c99a; border-radius: 5px; font-family: Arial, sans-serif; font-size: 0.8rem; background: white; color: var(--dark); }
  .setup-input:focus { outline: none; border-color: var(--accent2); }
  .btn-connect { padding: 0.5rem 1rem; background: var(--accent); color: white; border: none; border-radius: 5px; font-family: Arial, sans-serif; font-size: 0.8rem; cursor: pointer; white-space: nowrap; transition: background 0.2s; }
  .btn-connect:hover { background: #6a4c30; }
  .connected-badge { display: inline-flex; align-items: center; gap: 0.35rem; background: rgba(61,107,74,0.1); border: 1px solid rgba(61,107,74,0.3); color: var(--green); border-radius: 20px; padding: 0.25rem 0.7rem; font-size: 0.75rem; font-weight: 500; }
  .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.75rem; }
  .filter-wrap { display: flex; align-items: center; gap: 0.6rem; }
  .filter-wrap label { font-size: 0.8rem; color: var(--mid); }
  .filter-select { padding: 0.45rem 2rem 0.45rem 0.8rem; border: 1px solid var(--border); border-radius: 5px; background: white; font-family: Arial, sans-serif; font-size: 0.83rem; color: var(--dark); cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%236b5f52' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.6rem center; }
  .table-card { background: white; border-radius: 10px; border: 1px solid var(--border); box-shadow: var(--shadow); overflow: hidden; }
  table { width: 100%; border-collapse: collapse; }
  thead { background: var(--dark); }
  thead th { padding: 0.9rem 1rem; text-align: left; font-size: 0.7rem; font-weight: 400; text-transform: uppercase; letter-spacing: 0.1em; color: var(--stone); }
  thead th:last-child { text-align: center; width: 80px; }
  tbody tr { border-bottom: 1px solid var(--border); transition: background 0.12s; }
  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: #fdfaf6; }
  tbody td { padding: 0.55rem 0.75rem; vertical-align: middle; }
  .cell-input { width: 100%; border: 1px solid transparent; border-radius: 4px; padding: 0.38rem 0.55rem; font-family: Arial, sans-serif; font-size: 0.875rem; color: var(--dark); background: transparent; transition: all 0.15s; }
  .cell-input:hover:not(:focus) { border-color: var(--border); background: var(--warm); }
  .cell-input:focus { outline: none; border-color: var(--accent2); background: white; box-shadow: 0 0 0 3px rgba(196,149,106,0.12); }
  .addr-sel { width: 100%; border: 1px solid transparent; border-radius: 4px; padding: 0.38rem 1.8rem 0.38rem 0.55rem; font-family: Arial, sans-serif; font-size: 0.82rem; font-weight: 500; color: var(--accent); background: var(--cream); cursor: pointer; transition: all 0.15s; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%237a5c3e' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.5rem center; }
  .addr-sel:focus { outline: none; border-color: var(--accent2); box-shadow: 0 0 0 3px rgba(196,149,106,0.12); }
  .row-actions { display: flex; justify-content: center; gap: 0.35rem; }
  .btn-icon { width: 26px; height: 26px; border-radius: 4px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; transition: all 0.15s; }
  .btn-del { background: #fdf0f0; color: var(--red); }
  .btn-del:hover { background: #f8d8d8; }
  .btn-dup { background: #f0f5f1; color: var(--green); }
  .btn-dup:hover { background: #d8ebd8; }
  .add-footer { padding: 0.8rem 1rem; background: #faf8f5; border-top: 1px solid var(--border); }
  .add-btn { display: inline-flex; align-items: center; gap: 0.5rem; background: none; border: 1px dashed var(--stone); border-radius: 5px; padding: 0.45rem 1.1rem; color: var(--mid); font-family: Arial, sans-serif; font-size: 0.82rem; cursor: pointer; transition: all 0.2s; }
  .add-btn:hover { border-color: var(--accent); color: var(--accent); background: #fdf8f3; }
  .toast { position: fixed; bottom: 2rem; right: 2rem; background: var(--dark); color: var(--cream); padding: 0.85rem 1.4rem; border-radius: 7px; font-size: 0.85rem; box-shadow: 0 6px 24px rgba(0,0,0,0.3); transform: translateY(80px); opacity: 0; transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1); z-index: 999; display: flex; align-items: center; gap: 0.5rem; max-width: 320px; }
  .toast.show { transform: translateY(0); opacity: 1; }
  .toast.success { border-left: 3px solid #6aaa64; }
  .toast.error { border-left: 3px solid #c0392b; }
  .toast.info { border-left: 3px solid var(--accent2); }
  @media (max-width: 680px) { header { padding: 1.1rem 1rem; } main { padding: 1rem 0.75rem 3rem; } .login-card { padding: 2rem 1.5rem; } table { font-size: 0.78rem; } }
</style>
</head>
<body>

<!-- PASSWORD SCREEN -->
<div id="passwordScreen">
  <div class="login-card">
    <div class="login-emblem">üè°</div>
    <h2>The Courtyard</h2>
    <p>Resident Directory ‚Äî enter your access code to continue</p>
    <div class="pw-field">
      <input type="password" id="pwInput" placeholder="Enter password" onkeydown="if(event.key==='Enter')checkPassword()">
    </div>
    <div class="pw-error" id="pwError"></div>
    <button class="login-btn" onclick="checkPassword()">ENTER DIRECTORY</button>
  </div>
</div>

<!-- MAIN APP -->
<div id="app">
  <header>
    <div class="header-brand">
      <h1>The Courtyard</h1>
      <p>Resident Directory</p>
    </div>
    <div class="header-actions">
      <span class="save-status" id="saveStatus">‚úì Saved</span>
      <button class="btn btn-outline" onclick="exportCSV()">‚¨á Export</button>
      <button class="btn btn-save" onclick="saveAll()">üíæ Save All</button>
      <button class="btn btn-lock" onclick="lockApp()">üîí Lock</button>
    </div>
  </header>

  <main>
    <div class="setup-banner" id="setupBanner" style="display:none">
      <div class="icon">‚öôÔ∏è</div>
      <div style="flex:1">
        <h3>Connect to Google Sheets ‚Äî one-time setup</h3>
        <p>To make data permanent and shared across all devices, paste your <code>Google Sheet ID</code> and <code>API Key</code> below. See the included <code>README.md</code> for step-by-step instructions.</p>
        <div class="setup-fields">
          <input class="setup-input" id="sheetId" placeholder="Google Sheet ID">
          <input class="setup-input" id="apiKey" placeholder="Google API Key">
          <button class="btn-connect" onclick="connectSheets()">Connect</button>
        </div>
        <p style="margin-top:0.5rem;font-size:0.75rem;color:#a08060">Until connected, data saves locally in this browser only. Once connected it syncs to Google Sheets for all devices.</p>
      </div>
    </div>

    <div class="stats-row">
      <div class="stat-card"><div class="stat-num" id="statResidents">0</div><div class="stat-label">Residents<br>listed</div></div>
      <div class="stat-card"><div class="stat-num" id="statAddresses">0</div><div class="stat-label">Addresses<br>occupied</div></div>
      <div class="stat-card"><div class="stat-num" id="statEmpty">0</div><div class="stat-label">Addresses<br>not yet listed</div></div>
    </div>

    <div class="toolbar">
      <div class="filter-wrap">
        <label>Filter by address:</label>
        <select class="filter-select" id="filterSelect" onchange="renderTable()">
          <option value="">All addresses</option>
        </select>
      </div>
      <button class="btn btn-accent" onclick="addRow('')">+ Add Resident</button>
    </div>

    <div class="table-card">
      <table>
        <thead>
          <tr>
            <th style="width:190px">Address</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Mobile Number</th>
            <th>Email Address</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
      <div class="add-footer">
        <button class="add-btn" onclick="addRow('')">Ôºã Add another resident</button>
      </div>
    </div>
  </main>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHANGE THE PASSWORD HERE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CONFIG = {
  password: 'cmcds',  // ‚Üê Change this to your chosen password
  sheetId: '',
  apiKey: '',
  sheetRange: 'Residents!A2:E500',
  scriptUrl: 'https://script.google.com/macros/s/AKfycbz03XiUfyTXLPlDJcNEFU8QhIVrjRNVQ4Io8Tfscjur7vZAMhitUJBBMs7jegCJJ8LL8w/exec'
};

const ADDRESSES = Array.from({length:14}, (_,i) => `${i+1} The Courtyard`);
let residents = [];
let hasUnsaved = false;
let sheetsConnected = false;

// ‚îÄ‚îÄ‚îÄ PASSWORD ‚îÄ‚îÄ‚îÄ
function checkPassword() {
  const val = document.getElementById('pwInput').value;
  const err = document.getElementById('pwError');
  if (val === CONFIG.password) {
    document.getElementById('passwordScreen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    sessionStorage.setItem('cyard_auth','1');
    initApp();
  } else {
    err.textContent = 'Incorrect password ‚Äî please try again.';
    const inp = document.getElementById('pwInput');
    inp.classList.add('shake'); inp.value = '';
    setTimeout(() => inp.classList.remove('shake'), 500);
    setTimeout(() => err.textContent = '', 3000);
  }
}

function lockApp() {
  sessionStorage.removeItem('cyard_auth');
  document.getElementById('app').style.display = 'none';
  document.getElementById('passwordScreen').style.display = 'flex';
  document.getElementById('pwInput').value = '';
}

// ‚îÄ‚îÄ‚îÄ GOOGLE SHEETS ‚îÄ‚îÄ‚îÄ
function connectSheets() {
  sheetsConnected = true;
  document.getElementById('setupBanner').innerHTML = `
    <div class="icon">‚úÖ</div>
    <div><h3>Connected to Google Sheets</h3>
    <p>Data is loading from and saving to your Google Sheet.</p>
    <span class="connected-badge">üü¢ Live connection active</span></div>`;
  loadFromSheets();
}

async function loadFromSheets() {
  if (!CONFIG.scriptUrl) return;
  try {
    const url = `${CONFIG.scriptUrl}?action=read`;
    const res = await fetch(url);
    const data = await res.json();
    if (data.status !== 'ok') { showToast('Error loading data: ' + data.message, 'error'); loadFromLocal(); return; }
    residents = data.rows.length ? data.rows.map(r => ({id:uid(), ...r})) : [blankRow()];
    renderTable(); updateStats(); populateFilter();
    showToast('‚úì Loaded from Google Sheets', 'success');
  } catch(e) {
    showToast('Could not reach Google Sheets ‚Äî using local data', 'error');
    loadFromLocal();
  }
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
function initApp() {
  if (CONFIG.scriptUrl) {
    sheetsConnected = true;
    connectSheets();
  } else {
    loadFromLocal();
  }
}

function loadFromLocal() {
  const saved = localStorage.getItem('cyard_residents');
  residents = saved ? JSON.parse(saved) : [blankRow()];
  renderTable(); updateStats(); populateFilter();
}

// ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ
function uid() { return Math.random().toString(36).substr(2,9); }
function blankRow(a='') { return {id:uid(), address:a, firstName:'', lastName:'', email:'', mobile:''}; }
function esc(s) { return (s||'').replace(/"/g,'&quot;').replace(/</g,'&lt;'); }

function collectFromDOM() {
  residents.forEach(r => {
    const row = document.querySelector(`tr[data-id="${r.id}"]`);
    if (row) {
      r.address = row.querySelector('.addr-sel').value;
      r.firstName = row.querySelector('.firstname-inp').value;
      r.lastName  = row.querySelector('.lastname-inp').value;
      r.email     = row.querySelector('.email-inp').value;
      r.mobile    = row.querySelector('.mob-inp').value;
    }
  });
}

function saveAll() {
  collectFromDOM();
  localStorage.setItem('cyard_residents', JSON.stringify(residents));
  hasUnsaved = false; setSaveStatus(true);
  updateStats(); populateFilter();
  if (sheetsConnected) {
    saveToSheets();
  } else {
    showToast('‚úì Saved locally', 'success');
  }
}

async function saveToSheets() {
  try {
    showToast('Saving to Google Sheets...', 'info');
    const res = await fetch(CONFIG.scriptUrl, {
      method: 'POST',
      body: JSON.stringify({action: 'write', rows: residents})
    });
    const data = await res.json();
    if (data.status === 'ok') {
      showToast('‚úì Saved to Google Sheets', 'success');
    } else {
      showToast('Error saving: ' + data.message, 'error');
    }
  } catch(e) {
    showToast('Could not save to Google Sheets', 'error');
  }
}

function markUnsaved() {
  if (!hasUnsaved) { hasUnsaved = true; setSaveStatus(false); }
}

function setSaveStatus(saved) {
  const el = document.getElementById('saveStatus');
  el.textContent = saved ? '‚úì Saved' : '‚óè Unsaved changes';
  el.className = saved ? 'save-status' : 'save-status unsaved';
}

// Auto-save on blur ‚Äî saves locally AND to Google Sheets
document.addEventListener('blur', e => {
  if (e.target.matches('.cell-input,.addr-sel')) {
    collectFromDOM();
    localStorage.setItem('cyard_residents', JSON.stringify(residents));
    setSaveStatus(true); hasUnsaved = false;
    updateStats(); populateFilter();
    if (sheetsConnected) saveToSheets();
  }
}, true);

// Warn user if they try to close/refresh with unsaved changes
window.addEventListener('beforeunload', e => {
  if (hasUnsaved) {
    e.preventDefault();
    e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
    return e.returnValue;
  }
});

// ‚îÄ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ‚îÄ
function addRow(address='') {
  collectFromDOM();
  residents.push(blankRow(address));
  renderTable(); updateStats(); markUnsaved();
  setTimeout(() => {
    const rows = document.querySelectorAll('#tableBody tr');
    if (rows.length) rows[rows.length-1].querySelector('.firstname-inp').focus();
  }, 40);
}

function deleteRow(id) {
  collectFromDOM();
  residents = residents.filter(r => r.id !== id);
  if (!residents.length) residents = [blankRow()];
  renderTable(); updateStats(); populateFilter(); markUnsaved();
}

function sortResidents() {
  residents.sort((a, b) => {
    const numA = parseInt(a.address) || 999;
    const numB = parseInt(b.address) || 999;
    if (numA !== numB) return numA - numB;
    // Same address ‚Äî sort by last name then first name
    return (a.lastName||'').localeCompare(b.lastName||'') || (a.firstName||'').localeCompare(b.firstName||'');
  });
}

function renderTable() {
  sortResidents();
  const filter = document.getElementById('filterSelect')?.value || '';
  const tbody = document.getElementById('tableBody');
  const list = filter ? residents.filter(r => r.address === filter) : residents;
  if (!list.length) {
    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:2.5rem;color:var(--mid);font-size:0.85rem">No residents match this filter.</td></tr>`;
    return;
  }
  tbody.innerHTML = list.map(r => `
    <tr data-id="${r.id}">
      <td>
        <select class="addr-sel" onchange="markUnsaved()">
          <option value="">‚Äî Select address ‚Äî</option>
          ${ADDRESSES.map(a=>`<option value="${a}"${r.address===a?' selected':''}>${a}</option>`).join('')}
        </select>
      </td>
      <td><input class="cell-input firstname-inp" type="text" placeholder="First name" value="${esc(r.firstName)}" oninput="markUnsaved()"></td>
      <td><input class="cell-input lastname-inp" type="text" placeholder="Last name" value="${esc(r.lastName)}" oninput="markUnsaved()"></td>
      <td><input class="cell-input mob-inp" type="tel" placeholder="07700 000000" value="${esc(r.mobile)}" oninput="markUnsaved()"></td>
      <td><input class="cell-input email-inp" type="email" placeholder="email@example.com" value="${esc(r.email)}" oninput="markUnsaved()"></td>
      <td>
        <div class="row-actions">
          <button class="btn-icon btn-dup" title="Add another resident at this address" onclick="addRow('${r.address}')">Ôºã</button>
          <button class="btn-icon btn-del" title="Remove this resident" onclick="deleteRow('${r.id}')">‚úï</button>
        </div>
      </td>
    </tr>`).join('');
}

function updateStats() {
  const named = residents.filter(r=>r.firstName.trim()).length;
  const occupied = new Set(residents.filter(r=>r.address).map(r=>r.address)).size;
  document.getElementById('statResidents').textContent = named;
  document.getElementById('statAddresses').textContent = occupied;
  document.getElementById('statEmpty').textContent = 14 - occupied;
}

function populateFilter() {
  const sel = document.getElementById('filterSelect');
  const cur = sel.value;
  sel.innerHTML = '<option value="">All addresses</option>' +
    ADDRESSES.map(a=>`<option value="${a}"${cur===a?' selected':''}>${a}</option>`).join('');
}

function exportCSV() {
  collectFromDOM();
  const rows = [['Address','First Name','Last Name','Mobile','Email']];
  residents.forEach(r => { if (r.firstName||r.lastName||r.email||r.mobile) rows.push([r.address,r.firstName,r.lastName,r.mobile,r.email]); });
  const csv = rows.map(r=>r.map(c=>`"${(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
  a.download = 'courtyard-directory.csv';
  a.click();
  showToast('‚¨á CSV downloaded', 'success');
}

function showToast(msg, type='success') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = `toast ${type} show`;
  clearTimeout(t._t);
  t._t = setTimeout(() => t.className = `toast ${type}`, 3500);
}

// Auto-unlock if same session
if (sessionStorage.getItem('cyard_auth')==='1') {
  document.getElementById('passwordScreen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  initApp();
}
</script>
</body>
</html>
